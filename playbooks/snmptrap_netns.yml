
---
- name: Send SNMP traps from a dedicated network namespace (real source IP)
  hosts: localhost
  gather_facts: no
  vars:
    ns_name: snmptrapns
    # The IP you want traps to appear from (lab range).
    ns_ip: "192.168.1.50/24"
    ns_gw: "192.168.1.1"
    # Peer veth toward the host/root namespace.
    veth_host: "veth-host"
    veth_ns: "veth-ns"
    # Target trap receiver (your NMS)
    trap_target: "192.168.1.119"
    trap_community: "public"
    sleep_interval: 5
    # OIDs (linkUp/Down pattern for interface 5)
    trap_oid: "1.3.6.1.6.3.1.1.5.4"
    oid_ifIndex: "1.3.6.1.2.1.2.2.1.1.5"
    oid_ifAdminStatus: "1.3.6.1.2.1.2.2.1.7.5"
    oid_ifOperStatus: "1.3.6.1.2.1.2.2.1.8.5"

  tasks:
    - name: Ensure iproute2 and net-snmp-utils are present
      ansible.builtin.package:
        name:
          - iproute2
          - snmp
        state: present
      become: yes

    - name: Create network namespace
      ansible.builtin.command: "ip netns add {{ ns_name }}"
      become: yes
      register: ns_add
      changed_when: ns_add.rc == 0
      failed_when: ns_add.rc not in [0,1]  # ignore if exists

    - name: Create veth pair
      ansible.builtin.command: "ip link add {{ veth_host }} type veth peer name {{ veth_ns }}"
      become: yes
      register: veth_add
      changed_when: veth_add.rc == 0
      failed_when: veth_add.rc not in [0,2]  # ignore if exists

    - name: Move {{ veth_ns }} into namespace
      ansible.builtin.command: "ip link set {{ veth_ns }} netns {{ ns_name }}"
      become: yes

    - name: Bring up host-side veth
      ansible.builtin.command: "ip link set {{ veth_host }} up"
      become: yes

    - name: Configure IP inside namespace
      ansible.builtin.shell: |
        ip netns exec {{ ns_name }} bash -c '
          ip link set lo up
          ip link set {{ veth_ns }} up
          ip addr add {{ ns_ip }} dev {{ veth_ns }}
          # Optional default route if needed:
          ip route add default via {{ ns_gw }} || true
        '
      become: yes

    - name: Continuous trap loop (UP/DOWN)
      ansible.builtin.shell: |
        ip netns exec {{ ns_name }} bash -c '
          while true; do
            # Link UP
            snmptrap -v2c -c {{ trap_community }} {{ trap_target }} "" {{ trap_oid }} \
              {{ oid_ifIndex }} i 5 \
              {{ oid_ifAdminStatus }} i 1 \
              {{ oid_ifOperStatus }} i 1
            sleep {{ sleep_interval }}
            echo; date; echo "port 5 link UP (src={{ ns_ip }})"

            # Link DOWN
            snmptrap -v2c -c {{ trap_community }} {{ trap_target }} "" {{ trap_oid }} \
              {{ oid_ifIndex }} i 5 \
              {{ oid_ifAdminStatus }} i 1 \
              {{ oid_ifOperStatus }} i 2
            sleep {{ sleep_interval }}
            echo; date; echo "port 5 link DOWN (src={{ ns_ip }})"
          done
        '
      args:
        executable: /bin/bash
      become: yes
